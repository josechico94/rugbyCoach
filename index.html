<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RugbyCoach ‚Äî Beta completa (multi-select + ball carry + Firebase)</title>
  <style>
    :root{
      --sidebar-w: 360px;
      --player-size: 40px;
      --player-font: 14px;
      --blue:#0d6efd;
      --red:#e63946;
      --ink:#e6edf3;
      --panel:#0f1720;
      --panel-2:#111923;
      --border:#1f2a36;
      --shadow:0 4px 16px rgba(0,0,0,.25);
      --grid: rgba(255,255,255,.08);
      --yellow:#ffd400;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0b1720;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,"Noto Sans",sans-serif}
    .app{height:100dvh;display:grid;grid-template-columns:var(--sidebar-w) 1fr}
    .sidebar{background:var(--panel-2);border-right:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:12px;overflow:auto;z-index:1000;-webkit-overflow-scrolling:touch}
    .sidebar h1{font-size:18px;margin:0 0 8px 0}
    .group{border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:12px;display:grid;gap:10px}
    .group strong{font-size:12px;text-transform:uppercase;letter-spacing:.06em;opacity:.9}
    .row{display:grid;gap:8px}
    .btn, select, input[type="text"], input[type="number"], input[type="password"], input[type="email"], label.chk{
      appearance:none;border:1px solid #263443;background:#15202b;color:var(--ink);
      padding:.55rem .7rem;border-radius:10px;box-shadow:var(--shadow);font-size:14px
    }
    .btn{cursor:pointer;text-align:center}
    .btn:hover{filter:brightness(1.08)}
    .btn.alt{background:#0e2235}
    .btn.ghost{background:transparent;border-color:#2a3a4d}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#08220f;font-weight:700}
    .legend{display:flex;align-items:center;gap:8px;font-size:13px}
    .swatch{width:.9em;height:.9em;border-radius:50%;display:inline-block}
    .stage{position:relative;display:grid;place-items:center;padding:16px;overflow:hidden}
    .board-viewport{position:relative;width:100%;height:100%;contain:layout paint}
    .board-wrap{position:absolute;width:1200px;height:700px;transform-origin:top left}
    .board{position:absolute;inset:0;background:#137a46;overflow:hidden;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .board::before{
      content:"";position:absolute;inset:0;pointer-events:none;
      background-image:linear-gradient(90deg, rgba(255,255,255,.02) 0 5%, transparent 5% 10%, rgba(255,255,255,.02) 10% 15%, transparent 15% 20%, rgba(255,255,255,.02) 20% 25%, transparent 25% 30%, rgba(255,255,255,.02) 30% 35%, transparent 35% 40%, rgba(255,255,255,.02) 40% 45%, transparent 45% 50%, rgba(255,255,255,.02) 50% 55%, transparent 55% 60%, rgba(255,255,255,.02) 60% 65%, transparent 65% 70%, rgba(255,255,255,.02) 70% 75%, transparent 75% 80%, rgba(255,255,255,.02) 80% 85%, transparent 85% 90%, rgba(255,255,255,.02) 90% 95%, transparent 95% 100%);
    }
    .grid-overlay{position:absolute;inset:0;pointer-events:none;opacity:.6;display:none}
    .grid-overlay.active{display:block}
    .lines,#draw{position:absolute;inset:0;pointer-events:none}
    svg{width:100%;height:100%;display:block}
    #players{position:absolute;inset:0;z-index:3;pointer-events:none}
    .player{pointer-events:auto;position:absolute;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:14px;color:#fff;cursor:grab;border:2px solid #fff;box-shadow:var(--shadow);user-select:none;transform:translate(-50%, -50%)}
    .player:active,#ball:active{cursor:grabbing!important}
    .blue{background:var(--blue)} .red{background:var(--red)}
    #ball{position:absolute;z-index:4}
    .ball{width:50px;height:30px;background:var(--yellow);border:2px solid #fff;border-radius:50% / 60%;transform:translate(-50%, -50%) rotate(-15deg);box-shadow:0 3px 12px rgba(0,0,0,.35);cursor:grab}
    .ball::after{content:"";position:absolute;inset:6px 18px;border-radius:50% / 60%;border:2px dashed rgba(0,0,0,.25)}
    .label{font-size:12px;font-weight:700;fill:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .hamburger{position:fixed;top:calc(12px + env(safe-area-inset-top));left:calc(12px + env(safe-area-inset-left));width:44px;height:44px;display:none;place-items:center;font-size:20px;border:1px solid #263443;background:#15202b;color:var(--ink);border-radius:10px;box-shadow:var(--shadow);z-index:1100}
    .hamburger.open{background:#1d2a38}
    .scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:900}
    .scrim.show{opacity:1;pointer-events:auto}
    .selection-rect{position:absolute;border:2px dashed rgba(255,255,255,.6);background:rgba(255,255,255,.1);pointer-events:none;z-index:5}
    .player.selected{outline:3px solid #ffd400; outline-offset:2px}
    /* Pantalla de login con onda */
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 20% 10%, #1a2635, #0b1720)}
    .card{width:min(92vw,420px);background:rgba(16,24,34,.85);border:1px solid #1f2a36;border-radius:16px;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,.35);backdrop-filter:blur(6px);display:grid;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:4px}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:#0d6efd;display:grid;place-items:center;font-weight:900;color:#fff}
    .brand h2{margin:0;font-size:18px}
    .muted{opacity:.85;font-size:13px}
    .hint{font-size:12px;opacity:.8}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .or{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;color:#98a6b8}
    .or::before,.or::after{content:"";height:1px;background:#27364a}
    @media (max-width: 900px){
      :root{--sidebar-w:min(86vw,420px)}
      html,body{overflow:hidden;height:100dvh}
      .app{grid-template-columns:1fr;height:100dvh}
      .sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);transform:translateX(-105%);transition:transform .25s ease;padding-top:calc(12px + env(safe-area-inset-top))}
      .sidebar.open{transform:translateX(0)}
      .hamburger{display:inline-grid}
      .stage{padding:0}
      .board-viewport{position:fixed;top:0;left:0;right:0;bottom:0;overflow:hidden;background:#0b1720}
    }
  </style>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>
</head>
<body>
  <button id="menuBtn" class="hamburger" aria-label="Apri/Chiudi pannello">‚ò∞</button>
  <div id="scrim" class="scrim" aria-hidden="true"></div>

  <!-- Gate / Login -->
  <div id="gate" class="gate" hidden>
    <div class="card">
      <div class="brand">
        <div class="logo">RC</div>
        <h2>RugbyCoach</h2>
      </div>
      <p class="muted">Accedi per usare la lavagna, salvare giocate nel cloud, ed esportare video.</p>

      <div class="row">
        <label>Email
          <input id="email" type="email" placeholder="you@example.com" />
        </label>
      </div>
      <div class="row">
        <label>Password
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </label>
      </div>
      <div class="row2">
        <button id="btnEmailLogin" class="btn primary">Entra</button>
        <button id="btnEmailSignup" class="btn alt">Crea account</button>
      </div>
      <div class="or">oppure</div>
      <button id="btnGoogle" class="btn ghost">üîê Accedi con Google</button>
      <div id="authError" class="hint" style="color:#ff9090"></div>
      <div class="hint">Accedendo accetti i Termini e la Privacy Policy del club.</div>
    </div>
  </div>

  <div class="app" id="app" hidden>
    <aside class="sidebar" id="sidebar">
      <h1>Lavagna di Rugby</h1>

      <div class="group">
        <strong>Sessione</strong>
        <div class="row" style="grid-template-columns: 1fr auto;align-items:center">
          <div id="userInfo" class="muted">‚Äî</div>
          <button id="btnLogout" class="btn">Logout</button>
        </div>
      </div>

      <div class="group">
        <strong>Controlli</strong>
        <div class="row" style="grid-template-columns: 1fr;">
          <button class="btn" id="toggleLabels">Mostra etichette</button>
          <button class="btn alt" id="reset">Reimposta posizioni</button>
        </div>
        <label class="chk" style="display:flex;align-items:center;gap:8px;border:none;background:transparent;padding:0;box-shadow:none">
          <input type="checkbox" id="snapToggle"> Aggancia alla griglia
        </label>
        <label class="chk" style="display:flex;align-items:center;gap:8px;border:none;background:transparent;padding:0;box-shadow:none">
          <input type="checkbox" id="verticalField"> Campo vertical
        </label>
        <div class="legend"><span class="swatch" style="background:#0d6efd"></span> Blu (1‚Äì15)</div>
        <div class="legend"><span class="swatch" style="background:#e63946"></span> Rossi (1‚Äì15)</div>
      </div>

      <div class="group">
        <strong>Strumenti</strong>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <button class="btn" id="toolSelect">Seleziona</button>
          <button class="btn alt" id="toolPen">Matita</button>
        </div>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <label>Colore
            <select id="strokeColor">
              <option value="#ffffff">Bianco</option>
              <option value="#35d07f">Verde</option>
              <option value="#0d6efd">Blu</option>
              <option value="#e63946">Rosso</option>
              <option value="#f4d35e" selected>Giallo</option>
            </select>
          </label>
          <label>Spessore
            <select id="strokeWidth">
              <option value="3">Sottile</option>
              <option value="5" selected>Medio</option>
              <option value="7">Grosso</option>
            </select>
          </label>
        </div>
        <label class="chk" style="border:none;background:transparent;padding:0;box-shadow:none">
          <input type="checkbox" id="dashedToggle"> Linea tratteggiata
        </label>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <button class="btn" id="undoGeneric">Annulla</button>
          <button class="btn" id="clearArrows">Cancella frecce/linee</button>
        </div>
        <button class="btn" id="clearAll">Cancella tutto</button>
      </div>

      <div class="group">
        <strong>Giocate</strong>
        <input type="text" id="playName" placeholder="Nome giocata" />
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <button class="btn" id="savePlayLocal">Salva (Locale)</button>
          <button class="btn alt" id="savePlayCloud">Salva (Cloud)</button>
        </div>
        <select id="loadPlay"></select>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <button class="btn" id="loadSelected">Carica</button>
          <button class="btn" id="deleteSelected">Elimina</button>
        </div>
      </div>

      <div class="group">
        <strong>Animazione</strong>
        <div class="row" style="grid-template-columns: 1fr 1fr; gap:8px;">
          <button class="btn" id="recordStepBtn">Registra passo</button>
          <label class="chk" style="display:flex;align-items:center;gap:8px;border:none;background:transparent;padding:.4rem .6rem;box-shadow:none">
            <input type="checkbox" id="autoRecord"> Auto al rilascio
          </label>
        </div>

        <div class="row" style="grid-template-columns: 1fr 1fr 1fr; gap:8px;">
          <button class="btn" id="playBtn">Play</button>
          <button class="btn alt" id="pauseBtn">Pause</button>
          <button class="btn" id="stopBtn">Stop</button>
        </div>

        <div class="row" style="grid-template-columns: auto 1fr; align-items:center;">
          Velocit√† (ms per segmento)
          <input type="number" id="speedInput" min="100" step="100" value="800" />
        </div>

        <div class="row" style="grid-template-columns: 1fr; gap:8px;">
          <label>Scrubber (0 ‚Üí N)
            <input type="range" id="scrubber" min="0" max="0" value="0" />
          </label>
          <div style="display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;">
            <button class="btn alt" id="prevFrameBtn">‚óÄ Precedente</button>
            <div style="text-align:center;">Frame: <span id="scrubberVal">0</span> / <span id="frameTotal">0</span></div>
            <button class="btn alt" id="nextFrameBtn">Successivo ‚ñ∂</button>
          </div>
        </div>

        <div class="row" style="grid-template-columns: 1fr 1fr; gap:8px;">
          <button class="btn alt" id="clearTimelineBtn">Pulisci</button>
          <button class="btn" id="exportTimelineBtn">Export JSON</button>
        </div>
        <button class="btn alt" id="importTimelineBtn">Import JSON</button>
        <div style="font-size:12px;opacity:.8;">Frames salvati: <span id="frameCount">0</span></div>
      </div>

      <div class="group">
        <strong>Export</strong>
        <div class="row" style="grid-template-columns: 1fr;">
          <button class="btn" id="exportJpgBtn">Export immagine (JPG)</button>
          <button class="btn alt" id="exportVideoBtn">Export video (WebM)</button>
          <button class="btn" id="exportMp4Btn">Export MP4 (beta)</button>
          <small class="hint">Il video include giocatori, pallone, frecce e linee. MP4 usa ffmpeg.wasm.</small>
          <div id="ffmpegStatus" class="hint"></div>
        </div>
      </div>
    </aside>

    <main class="stage">
      <div class="board-viewport" id="boardViewport">
        <div class="board-wrap" id="boardWrap">
          <div id="board" class="board">
            <svg class="grid-overlay" id="grid" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>

            <svg class="lines" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
              <rect x="5" y="5" width="1190" height="690" fill="none" stroke="#fff" stroke-width="6" />
              <rect x="0" y="0" width="80" height="700" fill="rgba(255,255,255,.07)" />
              <rect x="1120" y="0" width="80" height="700" fill="rgba(255,255,255,.07)" />
              <line x1="80" y1="0" x2="80" y2="700" stroke="#fff" stroke-width="4" />
              <line x1="1120" y1="0" x2="1120" y2="700" stroke="#fff" stroke-width="4" />
              <line x1="309" y1="0" x2="309" y2="700" stroke="#fff" stroke-width="3" />
              <line x1="891" y1="0" x2="891" y2="700" stroke="#fff" stroke-width="3" />
              <line x1="500" y1="0" x2="500" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10" />
              <line x1="697" y1="0" x2="697" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10" />
              <line x1="600" y1="0" x2="600" y2="700" stroke="#fff" stroke-width="4" />
              <line x1="5" y1="50" x2="1195" y2="50" stroke="#fff" stroke-width="2" stroke-dasharray="4 8" />
              <line x1="5" y1="150" x2="1195" y2="150" stroke="#fff" stroke-width="2" stroke-dasharray="4 8" />
              <line x1="5" y1="550" x2="1195" y2="550" stroke="#fff" stroke-width="2" stroke-dasharray="4 8" />
              <line x1="5" y1="650" x2="1195" y2="650" stroke="#fff" stroke-width="2" stroke-dasharray="4 8" />
              <line x1="130" y1="0" x2="130" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
              <line x1="1070" y1="0" x2="1070" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
            </svg>

            <svg id="draw" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
            <div id="players"></div>
            <div id="ball" class="ball" title="Pallone"></div>
          </div>
        </div>
      </div>
      <div id="selectionRect" class="selection-rect" style="display:none"></div>
      <canvas id="exportCanvas" width="1200" height="700" style="position:fixed; top:-9999px; left:-9999px;"></canvas>
    </main>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    /*************** Firebase (SDK modular) ***************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, 
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection 
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACU3QfuTpW6PNRt3hHl9m1dy4Vso0GPoI",
      authDomain: "bologna-rugby-club.firebaseapp.com",
      projectId: "bologna-rugby-club",
      storageBucket: "bologna-rugby-club.appspot.com",
      messagingSenderId: "641438144435",
      appId: "1:641438144435:web:e2a243bacd522fd1615dc6",
      measurementId: "G-9C66KXJ561"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);
    analyticsSupported().then(ok => { if (ok) getAnalytics(appFB); });

    /*************** Estado ***************/
    const WIDTH=1200, HEIGHT=700, GRID_SIZE=24;
    const TL_KEY='rugby-timeline-v2';
    const POS_KEY='rugby-positions-v3';
    const ARROW_KEY='rugby-arrows-v3';
    const STROKE_KEY='rugby-strokes-v1';
    const BALL_KEY='rugby-ball-v1';
    const PLAY_PREFIX='play-v3-';

    let appState={
      layout:{mode:'landscape',scale:1,tx:0,ty:0,forceVertical:false},
      tool:'select', // default selecci√≥n
      arrows:[],strokes:[],
      drawingStroke:false,startPoint:null,currentStroke:null,
      timeline:[], playing:false, paused:false, playIndex:0,
      rafId:null, segmentStartTime:0, segmentDuration:800, fromFrame:null,
      // selecci√≥n m√∫ltiple
      selected:new Set(), marqueeStart:null, isDraggingSelection:false,
      dragStartPositions:new Map()
    };

    const dom={
      app: document.getElementById('app'),
      gate: document.getElementById('gate'),
      authError: document.getElementById('authError'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      btnEmailLogin: document.getElementById('btnEmailLogin'),
      btnEmailSignup: document.getElementById('btnEmailSignup'),
      btnGoogle: document.getElementById('btnGoogle'),
      btnLogout: document.getElementById('btnLogout'),
      userInfo: document.getElementById('userInfo'),

      boardViewport: document.getElementById('boardViewport'),
      boardWrap: document.getElementById('boardWrap'),
      board: document.getElementById('board'),
      playersLayer: document.getElementById('players'),
      draw: document.getElementById('draw'),
      gridSvg: document.getElementById('grid'),
      ball: document.getElementById('ball'),
      exportCanvas: document.getElementById('exportCanvas'),
      ctx: document.getElementById('exportCanvas').getContext('2d'),

      sidebar: document.getElementById('sidebar'),
      menuBtn: document.getElementById('menuBtn'),
      scrim: document.getElementById('scrim'),

      toggleLabelsBtn: document.getElementById('toggleLabels'),
      resetBtn: document.getElementById('reset'),
      snapToggle: document.getElementById('snapToggle'),
      verticalFieldChk: document.getElementById('verticalField'),

      toolSelectBtn: document.getElementById('toolSelect'),
      toolPenBtn: document.getElementById('toolPen'),
      undoGenericBtn: document.getElementById('undoGeneric'),
      clearArrowsBtn: document.getElementById('clearArrows'),
      clearAllBtn: document.getElementById('clearAll'),
      strokeColorSel: document.getElementById('strokeColor'),
      strokeWidthSel: document.getElementById('strokeWidth'),
      dashedToggle: document.getElementById('dashedToggle'),

      recordStepBtn: document.getElementById('recordStepBtn'),
      autoRecordChk: document.getElementById('autoRecord'),
      playBtn: document.getElementById('playBtn'),
      pauseBtn: document.getElementById('pauseBtn'),
      stopBtn: document.getElementById('stopBtn'),
      speedInput: document.getElementById('speedInput'),
      clearTimelineBtn: document.getElementById('clearTimelineBtn'),
      exportTimelineBtn: document.getElementById('exportTimelineBtn'),
      importTimelineBtn: document.getElementById('importTimelineBtn'),
      frameCountEl: document.getElementById('frameCount'),
      scrubber: document.getElementById('scrubber'),
      scrubberVal: document.getElementById('scrubberVal'),
      frameTotal: document.getElementById('frameTotal'),
      prevFrameBtn: document.getElementById('prevFrameBtn'),
      nextFrameBtn: document.getElementById('nextFrameBtn'),

      playNameInput: document.getElementById('playName'),
      loadPlaySel: document.getElementById('loadPlay'),
      savePlayLocalBtn: document.getElementById('savePlayLocal'),
      savePlayCloudBtn: document.getElementById('savePlayCloud'),
      loadSelectedBtn: document.getElementById('loadSelected'),
      deleteSelectedBtn: document.getElementById('deleteSelected'),

      exportJpgBtn: document.getElementById('exportJpgBtn'),
      exportVideoBtn: document.getElementById('exportVideoBtn'),
      exportMp4Btn: document.getElementById('exportMp4Btn'),
      ffmpegStatus: document.getElementById('ffmpegStatus'),

      selectionRect: document.getElementById('selectionRect'),
    };

    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const centerOf=el=>({x:parseFloat(el.style.left)||0, y:parseFloat(el.style.top)||0});
    const snap=v=>Math.round(v/GRID_SIZE)*GRID_SIZE;

    function toast(msg){ console.log('[INFO]', msg); }

    /*************** Layout ***************/
    const LayoutManager={
      isPortraitLike(){
        if(appState.layout.forceVertical) return true;
        const mq = window.matchMedia('(orientation: portrait)');
        return (mq && mq.matches) || (window.innerHeight > window.innerWidth);
      },
      applyUprightTransforms(){
        const rotatePlayers=(appState.layout.mode==='portrait');
        [...dom.playersLayer.children].forEach(el=>{
          el.style.transform = rotatePlayers? 'translate(-50%, -50%) rotate(-90deg)':'translate(-50%, -50%)';
        });
      },
      fitBoard(){
        const vp=dom.boardViewport.getBoundingClientRect();
        const availW=vp.width, availH=vp.height;

        if(!LayoutManager.isPortraitLike()){
          appState.layout.mode='landscape';
          appState.layout.scale=Math.min(availW/WIDTH, availH/HEIGHT);
          const scaledW=WIDTH*appState.layout.scale;
          const scaledH=HEIGHT*appState.layout.scale;
          appState.layout.tx=(availW - scaledW)/2;
          appState.layout.ty=(availH - scaledH)/2;
          dom.boardWrap.style.transform = `translate(${appState.layout.tx}px, ${appState.layout.ty}px) rotate(0deg) scale(${appState.layout.scale})`;
        }else{
          appState.layout.mode='portrait';
          const rotW=HEIGHT, rotH=WIDTH;
          appState.layout.scale=Math.min(availW/rotW, availH/rotH);
          const contentW=rotW*appState.layout.scale;
          const contentH=rotH*appState.layout.scale;
          const txCenter=(availW - contentW)/2;
          const tyCenter=(availH - contentH)/2;
          appState.layout.tx = txCenter + contentW;
          appState.layout.ty = tyCenter;
          dom.boardWrap.style.transform = `translate(${appState.layout.tx}px, ${appState.layout.ty}px) rotate(90deg) scale(${appState.layout.scale})`;
        }
        dom.boardWrap.style.transformOrigin='top left';
        LayoutManager.applyUprightTransforms();
      },
      clientToBoard(e){
        const vp=dom.boardViewport.getBoundingClientRect();
        const cx=e.clientX - vp.left, cy=e.clientY - vp.top;
        if(appState.layout.mode==='portrait'){
          const x_raw=(cx - appState.layout.tx);
          const y_raw=(cy - appState.layout.ty);
          const x = (y_raw)/appState.layout.scale;
          const y = (-x_raw)/appState.layout.scale;
          return {x:clamp(x,0,WIDTH), y:clamp(y,0,HEIGHT)};
        }else{
          const x=(cx - appState.layout.tx)/appState.layout.scale;
          const y=(cy - appState.layout.ty)/appState.layout.scale;
          return {x:clamp(x,0,WIDTH), y:clamp(y,0,HEIGHT)};
        }
      },
      deltaToBoard(dxClient,dyClient){
        if(appState.layout.mode==='portrait'){
          return {dx: dyClient/appState.layout.scale, dy: -dxClient/appState.layout.scale};
        }else{
          return {dx: dxClient/appState.layout.scale, dy: dyClient/appState.layout.scale};
        }
      },
      renderGrid(){
        const s=GRID_SIZE;
        dom.gridSvg.innerHTML='';
        const g=document.createElementNS('http://www.w3.org/2000/svg','g');
        for(let x=s;x<WIDTH;x+=s){
          const l=document.createElementNS('http://www.w3.org/2000/svg','line');
          l.setAttribute('x1',x);l.setAttribute('y1',0);l.setAttribute('x2',x);l.setAttribute('y2',HEIGHT);
          l.setAttribute('stroke','var(--grid)');l.setAttribute('stroke-width','1');g.appendChild(l);
        }
        for(let y=s;y<HEIGHT;y+=s){
          const l=document.createElementNS('http://www.w3.org/2000/svg','line');
          l.setAttribute('x1',0);l.setAttribute('y1',y);l.setAttribute('x2',WIDTH);l.setAttribute('y2',y);
          l.setAttribute('stroke','var(--grid)');l.setAttribute('stroke-width','1');g.appendChild(l);
        }
        dom.gridSvg.appendChild(g);
        dom.gridSvg.classList.toggle('active', dom.snapToggle.checked);
      }
    };

    /*************** Units (jugadores + bal√≥n) ***************/
    const UnitsManager={
      initialPositions:(function(){
        const pos=[];
        for(let i=1;i<=15;i++) pos.push({team:'blue', number:i, x:WIDTH*0.18, y:HEIGHT*(0.1 + (i-1)*(0.8/14))});
        for(let i=1;i<=15;i++) pos.push({team:'red', number:i, x:WIDTH*0.82, y:HEIGHT*(0.1 + (i-1)*(0.8/14))});
        return pos;
      })(),
      createPlayers(){
        dom.playersLayer.innerHTML='';
        UnitsManager.initialPositions.forEach(p=>{
          const el=document.createElement('div');
          el.className=`player ${p.team}`;
          el.textContent=p.number;
          el.style.left=p.x+'px'; el.style.top=p.y+'px';
          el.dataset.number=p.number; el.dataset.team=p.team;
          UnitsManager.enableDragPlayer(el);
          dom.playersLayer.appendChild(el);
        });
        LayoutManager.applyUprightTransforms();
      },
      enableDragPlayer(playerEl){
        let pointerId=null, startX=0, startY=0, origL=0, origT=0;

        // selecci√≥n con clic (Shift/Ctrl para multi)
        playerEl.addEventListener('pointerdown', (e)=>{
          if(appState.tool!=='select') return;
          const multi = e.shiftKey || e.ctrlKey || e.metaKey;
          if(!multi){ SelectionManager.clear(); SelectionManager.add(playerEl); }
          else{ if(appState.selected.has(playerEl)) SelectionManager.remove(playerEl); else SelectionManager.add(playerEl); }
        }, {passive:false});

        const onDown=(e)=>{
          pointerId=e.pointerId;
          playerEl.setPointerCapture(pointerId);
          e.preventDefault();
          startX=e.clientX; startY=e.clientY;
          origL=parseFloat(playerEl.style.left)||0;
          origT=parseFloat(playerEl.style.top)||0;

          const isSelected = appState.selected.has(playerEl);
          const multiDrag = (appState.selected.size>1 && isSelected);

          // mapear posiciones iniciales del grupo
          appState.dragStartPositions.clear();
          if(multiDrag){
            appState.isDraggingSelection=true;
            appState.selected.forEach(el=>{
              appState.dragStartPositions.set(el,{x:parseFloat(el.style.left)||0, y:parseFloat(el.style.top)||0});
            });
          }

          // === Porteo del bal√≥n ===
          const ballPos0={x:parseFloat(dom.ball.style.left)||0, y:parseFloat(dom.ball.style.top)||0};
          let carrierEl=null;
          let ballOffset={x:0,y:0};

          const nearBall=(el,thr=28)=>{
            const p={x:parseFloat(el.style.left)||0, y:parseFloat(el.style.top)||0};
            return Math.hypot(ballPos0.x - p.x, ballPos0.y - p.y) < thr;
          };

          if(multiDrag){
            for(const el of appState.selected){ if(nearBall(el)){ carrierEl=el; break; } }
            if(carrierEl){
              const p0=appState.dragStartPositions.get(carrierEl);
              ballOffset={x: ballPos0.x - p0.x, y: ballPos0.y - p0.y};
            }
          }else{
            if(nearBall(playerEl)){
              carrierEl=playerEl;
              ballOffset={x: ballPos0.x - origL, y: ballPos0.y - origT};
            }
          }

          const onMove=(ev)=>{
            if(ev.pointerId!==pointerId) return;
            ev.preventDefault();
            const {dx,dy}=LayoutManager.deltaToBoard(ev.clientX-startX, ev.clientY-startY);

            if(multiDrag){
              appState.dragStartPositions.forEach((pos,el)=>{
                const nx=clamp(pos.x+dx, 0, WIDTH);
                const ny=clamp(pos.y+dy, 0, HEIGHT);
                el.style.left=nx+'px'; el.style.top=ny+'px';
              });
              if(carrierEl){
                const p0=appState.dragStartPositions.get(carrierEl);
                const nbx=clamp(p0.x + dx + ballOffset.x, 0, WIDTH);
                const nby=clamp(p0.y + dy + ballOffset.y, 0, HEIGHT);
                dom.ball.style.left=nbx+'px'; dom.ball.style.top=nby+'px';
              }
            }else{
              const nx=clamp(origL+dx,0,WIDTH);
              const ny=clamp(origT+dy,0,HEIGHT);
              playerEl.style.left=nx+'px'; playerEl.style.top=ny+'px';
              if(carrierEl){
                dom.ball.style.left=clamp(nx + ballOffset.x, 0, WIDTH)+'px';
                dom.ball.style.top =clamp(ny + ballOffset.y, 0, HEIGHT)+'px';
              }
            }
          };

          const onUp=(ev)=>{
            if(ev.pointerId!==pointerId) return;
            try{ playerEl.releasePointerCapture(pointerId);}catch{}
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);

            const snapOne=(el)=>{
              const px=snap(parseFloat(el.style.left));
              const py=snap(parseFloat(el.style.top));
              el.style.left=px+'px'; el.style.top=py+'px';
            };
            if(dom.snapToggle.checked){
              if(appState.isDraggingSelection) appState.selected.forEach(snapOne);
              else snapOne(playerEl);
              if(carrierEl){
                dom.ball.style.left=snap(parseFloat(dom.ball.style.left))+'px';
                dom.ball.style.top =snap(parseFloat(dom.ball.style.top)) +'px';
              }
            }

            appState.isDraggingSelection=false;
            StorageManager.savePositions();
            StorageManager.saveBall();
            if(dom.autoRecordChk.checked) TimelineManager.recordFrame();
          };

          document.addEventListener('pointermove', onMove, {passive:false});
          document.addEventListener('pointerup', onUp, {passive:false});
        };

        playerEl.addEventListener('pointerdown', onDown, {passive:false});
        playerEl.ondragstart=()=>false;
      },
      placeBall(x=WIDTH*0.5,y=HEIGHT*0.5){
        dom.ball.style.left=x+'px'; dom.ball.style.top=y+'px';
        dom.ball.style.transform='translate(-50%, -50%) rotate(-15deg)';
      },
      enableDragBall(){
        let pointerId=null,startX=0,startY=0,origL=0,origT=0;
        dom.ball.addEventListener('pointerdown', (e)=>{
          pointerId=e.pointerId; dom.ball.setPointerCapture(pointerId);
          e.preventDefault();
          startX=e.clientX; startY=e.clientY;
          origL=parseFloat(dom.ball.style.left)||0;
          origT=parseFloat(dom.ball.style.top)||0;

          const onMove=(ev)=>{
            if(ev.pointerId!==pointerId) return;
            ev.preventDefault();
            const {dx,dy}=LayoutManager.deltaToBoard(ev.clientX-startX, ev.clientY-startY);
            dom.ball.style.left=clamp(origL+dx,0,WIDTH)+'px';
            dom.ball.style.top =clamp(origT+dy,0,HEIGHT)+'px';
          };
          const onUp=(ev)=>{
            if(ev.pointerId!==pointerId) return;
            try{ dom.ball.releasePointerCapture(pointerId);}catch{}
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);
            if(dom.snapToggle.checked){
              dom.ball.style.left=snap(parseFloat(dom.ball.style.left))+'px';
              dom.ball.style.top =snap(parseFloat(dom.ball.style.top)) +'px';
            }
            StorageManager.saveBall();
            if(dom.autoRecordChk.checked) TimelineManager.recordFrame();
          };

          document.addEventListener('pointermove', onMove, {passive:false});
          document.addEventListener('pointerup', onUp, {passive:false});
        }, {passive:false});
        dom.ball.ondragstart=()=>false;
      }
    };

    /*************** Selection Manager ***************/
    const SelectionManager={
      add(el){ el.classList.add('selected'); appState.selected.add(el); },
      remove(el){ el.classList.remove('selected'); appState.selected.delete(el); },
      clear(){ appState.selected.forEach(el=>el.classList.remove('selected')); appState.selected.clear(); },
      marqueeStart(pt){ appState.marqueeStart=pt; dom.selectionRect.style.display='block'; },
      marqueeMove(pt){
        const x1=Math.min(appState.marqueeStart.x, pt.x);
        const y1=Math.min(appState.marqueeStart.y, pt.y);
        const x2=Math.max(appState.marqueeStart.x, pt.x);
        const y2=Math.max(appState.marqueeStart.y, pt.y);

        dom.selectionRect.style.left   = (x1*appState.layout.scale + appState.layout.tx) + 'px';
        dom.selectionRect.style.top    = (y1*appState.layout.scale + appState.layout.ty) + 'px';
        dom.selectionRect.style.width  = ((x2-x1)*appState.layout.scale) + 'px';
        dom.selectionRect.style.height = ((y2-y1)*appState.layout.scale) + 'px';

        const inside=(el)=>{
          const cx=parseFloat(el.style.left)||0;
          const cy=parseFloat(el.style.top)||0;
          return (cx>=x1 && cx<=x2 && cy>=y1 && cy<=y2);
        };
        SelectionManager.clear();
        [...dom.playersLayer.children].forEach(el=>{ if(inside(el)) SelectionManager.add(el); });
      },
      marqueeEnd(){ dom.selectionRect.style.display='none'; appState.marqueeStart=null; }
    };

    /*************** Dibujo (solo lapicera) ***************/
    const DrawManager={
      clearDraw(){ dom.draw.innerHTML=''; appState.arrows=[]; appState.strokes=[]; StorageManager.saveArrows(); StorageManager.saveStrokes(); },
      clearArrows(){ appState.arrows=[]; appState.strokes=[]; DrawManager.renderDraw(); StorageManager.saveArrows(); StorageManager.saveStrokes(); },
      setTool(tool){ appState.tool=tool; dom.toolSelectBtn.classList.toggle('alt', tool!=='select'); dom.toolPenBtn.classList.toggle('alt', tool!=='pen'); dom.draw.style.pointerEvents=(tool==='pen')?'auto':'none'; },
      undoLast(){ if(appState.strokes.length>0){ appState.strokes.pop(); StorageManager.saveStrokes(); } DrawManager.renderDraw(); },
      renderDraw(){
        dom.draw.innerHTML='';
        appState.strokes.forEach(stroke=>{
          const poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');
          poly.setAttribute('points', stroke.points.map(p=>`${p.x},${p.y}`).join(' '));
          poly.setAttribute('fill','none'); poly.setAttribute('stroke', stroke.color);
          poly.setAttribute('stroke-width', stroke.width); poly.setAttribute('stroke-linecap','round'); poly.setAttribute('stroke-linejoin','round');
          if(stroke.dashed) poly.setAttribute('stroke-dasharray','12 8');
          dom.draw.appendChild(poly);
        });
      },
      enablePen(){
        dom.draw.addEventListener('pointerdown', (e)=>{
          if(appState.tool!=='pen'||e.button!==0) return;
          e.preventDefault();
          const {x,y}=LayoutManager.clientToBoard(e);
          appState.drawingStroke=true;
          appState.currentStroke={points:[{x,y}], color:dom.strokeColorSel.value, width:+dom.strokeWidthSel.value, dashed:dom.dashedToggle.checked};

          const onMove=(ev)=>{
            if(!appState.drawingStroke) return;
            const p=LayoutManager.clientToBoard(ev);
            appState.currentStroke.points.push({x:p.x,y:p.y});
            DrawManager.renderPreview(appState.currentStroke);
          };
          const onUp=()=>{
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);
            DrawManager.clearPreview();
            if(appState.currentStroke.points.length>1){
              appState.strokes.push(appState.currentStroke);
              StorageManager.saveStrokes();
              DrawManager.renderDraw();
            }
            appState.drawingStroke=false; appState.currentStroke=null;
          };
          document.addEventListener('pointermove', onMove, {passive:false});
          document.addEventListener('pointerup', onUp, {passive:false});
        }, {passive:false});
      },
      renderPreview(stroke){
        let poly=document.getElementById('strokePreview');
        if(!poly){ poly=document.createElementNS('http://www.w3.org/2000/svg','polyline'); poly.id='strokePreview'; dom.draw.appendChild(poly); }
        poly.setAttribute('points', stroke.points.map(p=>`${p.x},${p.y}`).join(' '));
        poly.setAttribute('fill','none'); poly.setAttribute('stroke', stroke.color);
        poly.setAttribute('stroke-width', stroke.width);
        poly.setAttribute('stroke-linecap','round'); poly.setAttribute('stroke-linejoin','round');
        if(stroke.dashed) poly.setAttribute('stroke-dasharray','12 8'); else poly.removeAttribute('stroke-dasharray');
      },
      clearPreview(){ const p=document.getElementById('strokePreview'); if(p) p.remove(); }
    };

    /*************** Animaci√≥n ***************/
    const TimelineManager={
      recordFrame(){
        const players=[...dom.playersLayer.children].map(el=>({team:el.dataset.team, number:+el.dataset.number, x:parseFloat(el.style.left), y:parseFloat(el.style.top)}));
        const ball={x:parseFloat(dom.ball.style.left)||WIDTH/2, y:parseFloat(dom.ball.style.top)||HEIGHT/2};
        const arrows=JSON.parse(JSON.stringify(appState.arrows));
        const strokes=JSON.parse(JSON.stringify(appState.strokes));

        if(appState.playIndex<appState.timeline.length){
          appState.timeline.splice(appState.playIndex,0,{players,ball,arrows,strokes});
          appState.playIndex++;
        }else{
          appState.timeline.push({players,ball,arrows,strokes});
          appState.playIndex=appState.timeline.length;
        }
        TimelineManager.updateScrubber();
        StorageManager.saveTimeline();
      },
      clearTimeline(){
        if(!confirm('Sei sicuro di eliminare la timeline?')) return;
        appState.timeline=[]; appState.playIndex=0;
        TimelineManager.updateScrubber();
        StorageManager.saveTimeline();
      },
      renderInterpolatedFrame(fromIndex,t){
        t=Math.max(0,Math.min(1,t||0));
        const f0=appState.timeline[fromIndex], f1=appState.timeline[fromIndex+1];
        if(!f0||!f1){ if(f0) TimelineManager.loadFrame(fromIndex); return; }
        const map=new Map();
        [...dom.playersLayer.children].forEach(el=>map.set(el.dataset.team+el.dataset.number, el));
        f0.players.forEach(p0=>{
          const el=map.get(p0.team+p0.number);
          if(el){
            const p1=f1.players.find(pp=>pp.team===p0.team && pp.number===p0.number) || p0;
            el.style.left=(p0.x+(p1.x-p0.x)*t)+'px';
            el.style.top =(p0.y+(p1.y-p0.y)*t)+'px';
          }
        });
        const bx=f0.ball.x+(f1.ball.x-f0.ball.x)*t;
        const by=f0.ball.y+(f1.ball.y-f0.ball.y)*t;
        UnitsManager.placeBall(bx,by);
        appState.arrows=JSON.parse(JSON.stringify(f0.arrows));
        appState.strokes=JSON.parse(JSON.stringify(f0.strokes));
        DrawManager.renderDraw();
        appState.playIndex=fromIndex;
        TimelineManager.updateScrubber();
        LayoutManager.applyUprightTransforms();
      },
      loadFrame(index){
        const f=appState.timeline[index]; if(!f) return;
        const map=new Map();
        [...dom.playersLayer.children].forEach(el=>map.set(el.dataset.team+el.dataset.number, el));
        f.players.forEach(p=>{ const el=map.get(p.team+p.number); if(el){ el.style.left=p.x+'px'; el.style.top=p.y+'px'; } });
        UnitsManager.placeBall(f.ball.x, f.ball.y);
        appState.arrows=JSON.parse(JSON.stringify(f.arrows)); appState.strokes=JSON.parse(JSON.stringify(f.strokes));
        DrawManager.renderDraw();
        appState.playIndex=index;
        TimelineManager.updateScrubber();
        LayoutManager.applyUprightTransforms();
      },
      updateScrubber(){
        const n=appState.timeline.length;
        dom.frameCountEl.textContent=n;
        dom.frameTotal.textContent=n;
        dom.scrubber.max=Math.max(0,n-1);
        dom.scrubber.value=appState.playIndex;
        dom.scrubberVal.textContent=appState.playIndex;
        if(n===0) dom.scrubber.value=0;
      },
      handleScrubberChange(e){
        const idx=parseInt(e.target.value);
        if(idx!==appState.playIndex && idx<appState.timeline.length) TimelineManager.loadFrame(idx);
      },
      play(ts){
        if(!appState.playing || appState.timeline.length<2){ appState.playing=false; appState.paused=false; dom.playBtn.textContent='Play'; return; }
        if(appState.paused){ appState.rafId=requestAnimationFrame(TimelineManager.play); return; }

        const dur=parseInt(dom.speedInput.value)||800;
        if(appState.fromFrame==null){
          if(isNaN(appState.playIndex)||appState.playIndex<0||appState.playIndex>=appState.timeline.length-1) appState.playIndex=0;
          appState.fromFrame=appState.playIndex;
          appState.segmentStartTime=ts;
          TimelineManager.renderInterpolatedFrame(appState.fromFrame,0);
        }
        if(appState.fromFrame>=appState.timeline.length-1){
          appState.playing=false; appState.paused=false; appState.fromFrame=null; dom.playBtn.textContent='Play'; TimelineManager.updateScrubber(); return;
        }
        const elapsed=ts - appState.segmentStartTime;
        let t=elapsed/dur;

        if(t>=1){
          appState.fromFrame+=1; appState.playIndex=appState.fromFrame; appState.segmentStartTime=ts;
          if(appState.fromFrame>=appState.timeline.length-1){
            TimelineManager.loadFrame(appState.playIndex);
            appState.playing=false; appState.paused=false; appState.fromFrame=null; dom.playBtn.textContent='Play'; TimelineManager.updateScrubber(); return;
          }else{
            TimelineManager.renderInterpolatedFrame(appState.fromFrame,0);
          }
        }else{
          TimelineManager.renderInterpolatedFrame(appState.fromFrame,t);
        }
        appState.rafId=requestAnimationFrame(TimelineManager.play);
      },
      startPlay(){
        if(appState.timeline.length<2) return;
        appState.segmentDuration=parseInt(dom.speedInput.value)||800;
        appState.playing=true; appState.paused=false; appState.fromFrame=null;
        dom.playBtn.textContent='Playing...';
        cancelAnimationFrame(appState.rafId);
        appState.rafId=requestAnimationFrame(TimelineManager.play);
      },
      pausePlay(){ appState.paused=true; dom.playBtn.textContent='Play'; dom.pauseBtn.textContent='Paused'; },
      stopPlay(){
        appState.playing=false; appState.paused=false; appState.fromFrame=null;
        try{ cancelAnimationFrame(appState.rafId);}catch{}
        dom.playBtn.textContent='Play'; dom.pauseBtn.textContent='Pause';
        if(appState.timeline.length>0) TimelineManager.loadFrame(0);
      }
    };

    /*************** Storage ***************/
    const StorageManager={
      savePositions(){
        const positions=[...dom.playersLayer.children].map(el=>({team:el.dataset.team, number:+el.dataset.number, x:parseFloat(el.style.left), y:parseFloat(el.style.top)}));
        localStorage.setItem(POS_KEY, JSON.stringify(positions));
      },
      loadPositions(){
        const saved=localStorage.getItem(POS_KEY);
        if(!saved){ UnitsManager.createPlayers(); return; }
        const positions=JSON.parse(saved);
        UnitsManager.createPlayers();
        const map=new Map();
        [...dom.playersLayer.children].forEach(el=>map.set(el.dataset.team+el.dataset.number, el));
        positions.forEach(p=>{ const el=map.get(p.team+p.number); if(el){ el.style.left=p.x+'px'; el.style.top=p.y+'px'; } });
        LayoutManager.applyUprightTransforms();
      },
      saveBall(){ localStorage.setItem(BALL_KEY, JSON.stringify(centerOf(dom.ball))); },
      loadBall(){ const s=localStorage.getItem(BALL_KEY); if(!s) return; const pos=JSON.parse(s); UnitsManager.placeBall(pos.x, pos.y); },
      saveArrows(){ localStorage.setItem(ARROW_KEY, JSON.stringify(appState.arrows)); },
      loadArrows(){ const s=localStorage.getItem(ARROW_KEY); if(s) appState.arrows=JSON.parse(s); },
      saveStrokes(){ localStorage.setItem(STROKE_KEY, JSON.stringify(appState.strokes)); },
      loadStrokes(){ const s=localStorage.getItem(STROKE_KEY); if(s) appState.strokes=JSON.parse(s); },
      saveTimeline(){ localStorage.setItem(TL_KEY, JSON.stringify(appState.timeline)); },
      loadTimeline(){ const s=localStorage.getItem(TL_KEY); if(s) appState.timeline=JSON.parse(s); TimelineManager.updateScrubber(); },

      exportTimeline(){
        const json=JSON.stringify(appState.timeline,null,2);
        const blob=new Blob([json],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=(dom.playNameInput.value?.trim()||'lavagna')+'_animazione.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      },
      importTimeline(){
        const input=document.createElement('input'); input.type='file'; input.accept='application/json';
        input.onchange=e=>{
          const file=e.target.files[0]; if(!file) return;
          const reader=new FileReader();
          reader.onload=ev=>{
            try{
              const timeline=JSON.parse(ev.target.result);
              if(Array.isArray(timeline)&&timeline.every(f=>f.players&&f.ball)){
                appState.timeline=timeline; StorageManager.saveTimeline(); TimelineManager.loadFrame(0); alert(`Animazione importata: ${timeline.length} frames.`);
              }else throw new Error('Formato JSON non valido');
            }catch(err){ alert('Errore: '+err.message); }
          };
          reader.readAsText(file);
        };
        input.click();
      },

      updatePlaySelect: async function(){
        try{
          dom.loadPlaySel.innerHTML='<option value="">-- Seleziona giocata --</option>';

          // Local
          const locals=[];
          for(let i=0;i<localStorage.length;i++){
            const k=localStorage.key(i);
            if(k.startsWith(PLAY_PREFIX)) locals.push(k.substring(PLAY_PREFIX.length));
          }
          locals.sort().forEach(name=>{
            const opt=document.createElement('option');
            opt.value='local:'+name; opt.textContent='üìÅ '+name+' (local)'; dom.loadPlaySel.appendChild(opt);
          });

          // Cloud
          if(auth.currentUser){
            try{
              const snap=await getDocs(collection(db,'users',auth.currentUser.uid,'plays'));
              const cloud=[]; snap.forEach(d=>cloud.push(d.id));
              cloud.sort().forEach(name=>{
                const opt=document.createElement('option');
                opt.value='cloud:'+name; opt.textContent='‚òÅÔ∏è '+name; dom.loadPlaySel.appendChild(opt);
              });
            }catch(err){ console.warn('Cloud list error:',err); toast('Non posso leggere il Cloud (permessi).'); }
          }
        }catch(err){ console.error('Error updating play select:',err); toast('Errore aggiornando la lista.'); }
      },

      savePlayLocal(){
        const name=dom.playNameInput.value?.trim();
        if(!name){ alert('Inserisci un nome.'); return; }
        if(appState.timeline.length===0){ alert('Aggiungi almeno un frame.'); return; }
        const playData={
          name, timeline:appState.timeline, arrows:appState.arrows, strokes:appState.strokes,
          positions:[...dom.playersLayer.children].map(el=>({team:el.dataset.team, number:+el.dataset.number, x:parseFloat(el.style.left), y:parseFloat(el.style.top)})),
          ball:centerOf(dom.ball),
        };
        try{
          localStorage.setItem(PLAY_PREFIX+name, JSON.stringify(playData));
          StorageManager.updatePlaySelect();
          toast('Giocata salvata localmente.');
        }catch(e){ alert('Errore nel salvataggio.'); }
      },

      savePlayCloud: async function(){
        const name=dom.playNameInput.value?.trim();
        if(!name){ alert('Inserisci un nome.'); return; }
        if(appState.timeline.length===0){ alert('Aggiungi almeno un frame.'); return; }
        const user=auth.currentUser; if(!user){ toast('Devi accedere per salvare nel Cloud.'); return; }

        const playData={
          name, timeline:appState.timeline, arrows:appState.arrows, strokes:appState.strokes,
          positions:[...dom.playersLayer.children].map(el=>({team:el.dataset.team, number:+el.dataset.number, x:parseFloat(el.style.left), y:parseFloat(el.style.top)})),
          ball:centerOf(dom.ball),
          updatedAt: Date.now()
        };
        try{
          await setDoc(doc(db,'users',user.uid,'plays', name), playData, {merge:true});
          toast('Giocata salvata nel Cloud.');
          await StorageManager.updatePlaySelect();
        }catch(e){ console.warn('Save cloud error:', e); toast('Permessi insufficienti o regole non valide.'); }
      },

      loadSelected: async function(){
        const val=dom.loadPlaySel.value; if(!val) return;
        const [source, name]=val.split(':');
        if(source==='local'){
          const raw=localStorage.getItem(PLAY_PREFIX+name); if(!raw) return;
          StorageManager.applyPlay(JSON.parse(raw));
        }else if(source==='cloud'){
          const user=auth.currentUser; if(!user){ toast('Accedi per caricare dal Cloud'); return; }
          try{
            const snap=await getDoc(doc(db,'users',user.uid,'plays', name));
            if(snap.exists()) StorageManager.applyPlay(snap.data());
            else toast('Giocata non trovata nel Cloud');
          }catch(e){ console.warn(e); toast('Errore nel caricamento dal Cloud'); }
        }
      },

      deleteSelected: async function(){
        const val=dom.loadPlaySel.value; if(!val) return;
        const [source, name]=val.split(':');
        if(!confirm(`Eliminare "${name}"?`)) return;
        if(source==='local'){
          localStorage.removeItem(PLAY_PREFIX+name);
          await StorageManager.updatePlaySelect();
          toast('Eliminata (local).');
        }else if(source==='cloud'){
          const user=auth.currentUser; if(!user){ toast('Accedi per eliminare dal Cloud'); return; }
          try{
            await deleteDoc(doc(db,'users',user.uid,'plays', name));
            await StorageManager.updatePlaySelect();
            toast('Eliminata dal Cloud.');
          }catch(e){ console.warn(e); toast('Permessi insufficienti.'); }
        }
      },

      applyPlay(playData){
        appState.timeline=playData.timeline||[];
        appState.arrows=playData.arrows||[];
        appState.strokes=playData.strokes||[];
        if(appState.timeline.length>0) TimelineManager.loadFrame(0);
        else if(playData.positions){
          const map=new Map();
          [...dom.playersLayer.children].forEach(el=>map.set(el.dataset.team+el.dataset.number, el));
          playData.positions.forEach(p=>{ const el=map.get(p.team+p.number); if(el){ el.style.left=p.x+'px'; el.style.top=p.y+'px'; } });
          UnitsManager.placeBall(playData.ball?.x||WIDTH/2, playData.ball?.y||HEIGHT/2);
          DrawManager.renderDraw();
        }else DrawManager.renderDraw();
        dom.playNameInput.value=playData.name||'';
        StorageManager.saveTimeline(); StorageManager.saveArrows(); StorageManager.saveStrokes(); StorageManager.savePositions(); StorageManager.saveBall();
        LayoutManager.applyUprightTransforms();
      }
    };

    /*************** Export ***************/
    const ExportManager={
      async drawPitch(ctx){
        ctx.clearRect(0,0,WIDTH,HEIGHT);
        ctx.fillStyle='#137a46'; ctx.fillRect(0,0,WIDTH,HEIGHT);
        const svgEl=dom.board.querySelector('.lines'); if(!svgEl) return;
        const svgData=new XMLSerializer().serializeToString(svgEl);
        const img=new Image();
        return new Promise(resolve=>{
          img.onload=()=>{ ctx.drawImage(img,0,0); resolve(); };
          img.onerror=()=>resolve();
          img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svgData)));
        });
      },
      drawPlayer(ctx,p){
        const r=20; ctx.save(); ctx.translate(p.x,p.y);
        ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2,true);
        ctx.fillStyle=(p.team==='blue'?'#0d6efd':'#e63946'); ctx.fill();
        ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle='#fff'; ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.number,0,1);
        ctx.restore();
      },
      drawBall(ctx,b){
        const W=50,H=30; ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(-15*Math.PI/180);
        ctx.beginPath(); ctx.ellipse(0,0,W/2,H/2,0,0,Math.PI*2); ctx.fillStyle='#ffd400'; ctx.fill();
        ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
        ctx.beginPath(); ctx.setLineDash([8,6]); ctx.ellipse(0,0,W/2-6,H/2-6,0,0,Math.PI*2); ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2; ctx.stroke();
        ctx.restore();
      },
      drawStroke(ctx,s){
        if(s.points.length<2) return;
        ctx.save(); ctx.beginPath(); ctx.moveTo(s.points[0].x,s.points[0].y);
        for(let i=1;i<s.points.length;i++) ctx.lineTo(s.points[i].x,s.points[i].y);
        ctx.strokeStyle=s.color; ctx.lineWidth=s.width; ctx.lineCap='round'; ctx.lineJoin='round';
        if(s.dashed) ctx.setLineDash([12,8]); ctx.stroke(); ctx.restore();
      },
      async renderFrameToCanvas(playersArr,ballPos,includeOverlays=true){
        await ExportManager.drawPitch(dom.ctx);
        playersArr.forEach(p=>ExportManager.drawPlayer(dom.ctx,p));
        ExportManager.drawBall(dom.ctx,ballPos);
        if(includeOverlays){ appState.strokes.forEach(s=>ExportManager.drawStroke(dom.ctx,s)); }
      },
      setupExportUI(){
        dom.exportJpgBtn.addEventListener('click', async ()=>{
          const playersNow=[...dom.playersLayer.children].map(el=>({team:el.dataset.team, number:+el.dataset.number, x:parseFloat(el.style.left), y:parseFloat(el.style.top)}));
          const ballNow={x:parseFloat(dom.ball.style.left)||WIDTH/2, y:parseFloat(dom.ball.style.top)||HEIGHT/2};
          await ExportManager.renderFrameToCanvas(playersNow, ballNow, true);
          const url=dom.exportCanvas.toDataURL('image/jpeg', .95);
          const a=document.createElement('a'); a.href=url; a.download=(dom.playNameInput.value?.trim()||'lavagna')+'_frame.jpg'; document.body.appendChild(a); a.click(); a.remove();
        });

        dom.exportVideoBtn.addEventListener('click', async ()=>{
          if(appState.timeline.length<2){ alert('Aggiungi almeno 2 frames.'); return; }
          if(!window.MediaRecorder){ alert('Il tuo browser non supporta MediaRecorder.'); return; }
          const stream=dom.exportCanvas.captureStream(30);
          const recorder=new MediaRecorder(stream, {mimeType:'video/webm; codecs=vp9'});
          const chunks=[];
          dom.exportVideoBtn.textContent='Registrando...'; dom.exportVideoBtn.disabled=true;
          recorder.ondataavailable=e=>chunks.push(e.data);
          recorder.onstop=()=>{
            const blob=new Blob(chunks,{type:'video/webm'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download=(dom.playNameInput.value?.trim()||'lavagna')+'_animazione.webm'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            dom.exportVideoBtn.textContent='Export video (WebM)'; dom.exportVideoBtn.disabled=false; if(appState.timeline.length>0) TimelineManager.loadFrame(0);
          };
          recorder.start();
          const duration=parseInt(dom.speedInput.value)||800;
          const total=appState.timeline.length; let i=0;
          const run=async ()=>{
            if(i>=total){ recorder.stop(); return; }
            const f=appState.timeline[i];
            await ExportManager.renderFrameToCanvas(f.players, f.ball, true);
            i++; setTimeout(run, duration);
          };
          await run();
        });

        dom.exportMp4Btn.addEventListener('click', ()=>{
          const win=window.open('exporter_mp4.html','_blank','noopener');
          if(!win){ alert('Permetti i popups per esportare MP4.'); return; }
          const payload={ timeline:appState.timeline, width:WIDTH, height:HEIGHT, segmentDuration:(parseInt(dom.speedInput.value)||800), name:(dom.playNameInput?.value?.trim()||'lavagna') };
          function onReady(e){ if(e.source===win && e.data==='EXPORTER_READY'){ window.removeEventListener('message', onReady); win.postMessage(payload,'*'); } }
          window.addEventListener('message', onReady);
        });
      }
    };

    /*************** UI ***************/
    const UIManager={
      setup(){
        window.addEventListener('resize', LayoutManager.fitBoard);
        dom.verticalFieldChk.addEventListener('change', ()=>{ appState.layout.forceVertical=dom.verticalFieldChk.checked; LayoutManager.fitBoard(); });

        // Men√∫ hamburguesa toggle (‚ò∞ ‚Üî ‚úï)
        const toggleMenu=()=>{
          const open=dom.sidebar.classList.toggle('open');
          dom.scrim.classList.toggle('show', open);
          dom.menuBtn.classList.toggle('open', open);
          dom.menuBtn.textContent = open ? '‚úï' : '‚ò∞';
        };
        dom.menuBtn.addEventListener('click', toggleMenu);
        dom.scrim.addEventListener('click', toggleMenu);

        dom.resetBtn.addEventListener('click', ()=>{
          SelectionManager.clear();
          UnitsManager.createPlayers(); UnitsManager.placeBall(); DrawManager.clearDraw();
          StorageManager.savePositions(); StorageManager.saveBall(); StorageManager.saveArrows(); StorageManager.saveStrokes();
        });
        dom.snapToggle.addEventListener('change', ()=>LayoutManager.renderGrid());
        dom.toggleLabelsBtn.addEventListener('click', (e)=>{
          e.target.classList.toggle('active');
          e.target.textContent= e.target.classList.contains('active') ? 'Ocultar etichette' : 'Mostra etichette';
          [...dom.playersLayer.children].forEach(el=>el.style.fontSize = e.target.classList.contains('active') ? 'var(--player-font)':'0');
        });

        dom.toolSelectBtn.addEventListener('click', ()=>DrawManager.setTool('select'));
        dom.toolPenBtn.addEventListener('click', ()=>DrawManager.setTool('pen'));
        dom.undoGenericBtn.addEventListener('click', DrawManager.undoLast);
        dom.clearArrowsBtn.addEventListener('click', DrawManager.clearArrows);
        dom.clearAllBtn.addEventListener('click', ()=>{ if(confirm('Eliminare tutti i disegni?')) DrawManager.clearDraw(); });

        dom.savePlayLocalBtn.addEventListener('click', StorageManager.savePlayLocal);
        dom.savePlayCloudBtn.addEventListener('click', StorageManager.savePlayCloud);
        dom.loadSelectedBtn.addEventListener('click', StorageManager.loadSelected);
        dom.deleteSelectedBtn.addEventListener('click', StorageManager.deleteSelected);

        dom.recordStepBtn.addEventListener('click', TimelineManager.recordFrame);
        dom.scrubber.addEventListener('input', TimelineManager.handleScrubberChange);
        dom.scrubber.addEventListener('change', TimelineManager.handleScrubberChange);
        dom.prevFrameBtn.addEventListener('click', ()=>TimelineManager.loadFrame(Math.max(0, appState.playIndex-1)));
        dom.nextFrameBtn.addEventListener('click', ()=>TimelineManager.loadFrame(Math.min(appState.timeline.length-1, appState.playIndex+1)));
        dom.playBtn.addEventListener('click', TimelineManager.startPlay);
        dom.pauseBtn.addEventListener('click', TimelineManager.pausePlay);
        dom.stopBtn.addEventListener('click', TimelineManager.stopPlay);
        dom.clearTimelineBtn.addEventListener('click', TimelineManager.clearTimeline);
        dom.exportTimelineBtn.addEventListener('click', StorageManager.exportTimeline);
        dom.importTimelineBtn.addEventListener('click', StorageManager.importTimeline);

        // Marquee en campo vac√≠o
        dom.board.addEventListener('pointerdown', (e)=>{
          if(appState.tool!=='select') return;
          if(e.target.closest('.player') || e.target.closest('#ball') || e.target.closest('#draw')) return;
          e.preventDefault();
          const p=LayoutManager.clientToBoard(e);
          SelectionManager.marqueeStart(p);

          const onMove=(ev)=>{ SelectionManager.marqueeMove(LayoutManager.clientToBoard(ev)); };
          const onUp=()=>{
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);
            SelectionManager.marqueeEnd();
          };
          document.addEventListener('pointermove', onMove, {passive:false});
          document.addEventListener('pointerup', onUp, {passive:false});
        }, {passive:false});
      }
    };

    /*************** Auth UI ***************/
    function showApp(authUser){
      if(authUser){
        dom.gate.hidden=true; dom.app.hidden=false;
        dom.userInfo.textContent = authUser.email || authUser.displayName || 'Utente';
      }else{
        dom.gate.hidden=false; dom.app.hidden=true;
      }
    }
    document.getElementById('btnGoogle').addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch(e){ dom.authError.textContent=e.message; }
    });
    document.getElementById('btnEmailLogin').addEventListener('click', async ()=>{
      try{ dom.authError.textContent=''; await signInWithEmailAndPassword(auth, dom.email.value.trim(), dom.password.value); }
      catch(e){ dom.authError.textContent=e.message; }
    });
    document.getElementById('btnEmailSignup').addEventListener('click', async ()=>{
      try{ dom.authError.textContent=''; await createUserWithEmailAndPassword(auth, dom.email.value.trim(), dom.password.value); }
      catch(e){ dom.authError.textContent=e.message; }
    });
    dom.btnLogout.addEventListener('click', ()=>signOut(auth));

    onAuthStateChanged(auth, async (user)=>{
      showApp(!!user);
      await StorageManager.updatePlaySelect(); // locales + cloud si hay sesi√≥n
    });

    /*************** INIT ***************/
    function init(){
      LayoutManager.renderGrid();
      DrawManager.setTool('select'); // default
      UnitsManager.createPlayers();
      StorageManager.loadPositions();
      StorageManager.loadArrows();
      StorageManager.loadStrokes();
      DrawManager.renderDraw();
      UnitsManager.placeBall(WIDTH/2, HEIGHT/2);
      StorageManager.loadBall();
      StorageManager.loadTimeline();
      TimelineManager.updateScrubber();

      if(!Array.isArray(appState.timeline)||appState.timeline.length===0){
        TimelineManager.recordFrame();
        appState.playIndex=0; TimelineManager.updateScrubber(); StorageManager.saveTimeline();
      }

      UIManager.setup();
      DrawManager.enablePen();
      dom.draw.style.pointerEvents='none'; // arranca en select
      UnitsManager.enableDragBall();
      StorageManager.updatePlaySelect();
      LayoutManager.fitBoard();
      showApp(!!auth.currentUser);
    }
    init();
  </script>
</body>
</html>
